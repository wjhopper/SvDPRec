---
title: "Participants Summary"
author: "William Hopper"
date: "`r format(Sys.Date(), '%b %d, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center")
library(rprojroot)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggrepel)
library(kableExtra)

root_dir <- rprojroot::is_rstudio_project$find_file()
source(file.path(root_dir, "R","load_data.R"))
```

```{r load_data}
test <- load_data("Test")
```

```{r score}
test <- mutate(test,
               speeded_correct = (type == "T" & speeded_judgment == "o") |
                                 (type == "L" & speeded_judgment == "n"),
               delayed_correct = (type == "T" & delayed_judgment == "o") |
                                 (type == "L" & delayed_judgment == "n")) %>%
  select(subject, session, trial:strength, word, 
         speeded_judgment, speeded_RT, speeded_correct,
         delayed_judgment, delayed_RT, delayed_correct)
```

## Dataset Description
```{r n_per_sub_session}
n_per_sub_session <- count(test, subject, session)

spread(n_per_sub_session, session, n, fill = 0) %>%
  rename(Subject = subject) %>%
  knitr::kable() %>%
  kableExtra::kable_styling(full_width = FALSE) %>%
  kableExtra::add_header_above(c(" " = 1,
                                 "Session" = length(unique(n_per_sub_session$session)))
                               )
```

## Recognition Accuracy
```{r accuracy_per_sub_session}
percent_correct_per_sub_session <- filter(test, !is.na(type)) %>%
  group_by(subject, session) %>%
  summarise_at(c("speeded_correct", "delayed_correct"), mean) %>%
  gather(key = "judgment", value = "PC", speeded_correct, delayed_correct) %>%
  mutate(judgment = factor(sub("_correct", "", judgment, fixed = TRUE),
                           levels = c("speeded","delayed"),
                           labels = c("Speeded", "Delayed")),
         session = factor(session))

```

```{r accuracy_per_sub_session_display}
PC_sub_session_plot <-
  ggplot(percent_correct_per_sub_session,
         aes(x=session, y=PC, group=subject)) +
  geom_point(size=1.5) +
  geom_line(size=.7) +
  facet_wrap(judgment~.) +
  scale_x_discrete("Session", expand = c(0,.5)) +
  scale_y_continuous("Percent Correct") +
  ggtitle("Recognition Accuracy") +
  theme_bw(base_size = 15) +
  theme(plot.title = element_text(hjust = .5))

subject_number_annotations <- 
  geom_text_repel(aes(label=subject),
                  direction = "y",
                  data = filter(percent_correct_per_sub_session,
                                session == 4),
                  nudge_x = 15, hjust = 0,
                  min.segment.length = 1,
                  box.padding = .15, 
                  arrow = arrow(length = unit(0.02, "npc"),
                                type = "open",
                                ends = "last")
                  )
print(PC_sub_session_plot + subject_number_annotations)  
```

```{r dprime_per_sub_session}
speeded_dprime_by_sub_session <- filter(test, !is.na(type)) %>%
  count(subject, session, type, speeded_correct) %>%
  unite(col = "resp_type", type, speeded_correct) %>%
  spread(resp_type, n) %>%
  rename(FA = L_FALSE, CR = L_TRUE, M = T_FALSE, H = T_TRUE) %>%
  mutate(dprime = qnorm(H/(M + H)) - qnorm(FA/(FA + CR)))

counts_by_sub_session_bias <- filter(test, !is.na(type)) %>%
  count(subject, session, type, pOld, delayed_correct) %>%
  complete(subject, session, type, pOld, delayed_correct,
           fill = list(n=0))

delayed_dprime_by_sub_session <- 
  group_by(counts_by_sub_session_bias,
           subject, session, type, delayed_correct) %>%
  summarise(n = sum(n)) %>%
  unite(col = "resp_type", type, delayed_correct) %>%
  spread(resp_type, n) %>%
  rename(FA = L_FALSE, CR = L_TRUE, M = T_FALSE, H = T_TRUE) %>%
  mutate(dprime = qnorm(H/(M + H)) - qnorm(FA/(FA + CR)))

dprime_by_sub_session <- bind_rows("speeded" = speeded_dprime_by_sub_session,
                                   "delayed" = delayed_dprime_by_sub_session,
                                   .id = "judgment") %>%
  select(subject, session, judgment, FA:dprime) %>%
  mutate(judgment = factor(judgment, levels = c("speeded","delayed"),
                           labels = c("Speeded", "Delayed")),
         session = factor(session)
         )

rm(speeded_dprime_by_sub_session, delayed_dprime_by_sub_session)
```

```{r dprime_per_sub_session_display}
subject_number_annotations <-
  geom_text_repel(aes(label=subject),
                  direction = "y",
                  data = filter(dprime_by_sub_session,
                                session == 4),
                  nudge_x = 15, hjust = 0,
                  min.segment.length = 1,
                  box.padding = .15, 
                  arrow = arrow(length = unit(0.02, "npc"),
                                type = "open",
                                ends = "last")
                  )
dprime_sub_sesssion_plot <- suppressMessages(
  PC_sub_session_plot %+%
    dprime_by_sub_session %+%
    aes(y=dprime) +
    subject_number_annotations +
    scale_y_continuous("d'") +
    ggtitle("Recognition Disciminability")
  )

print(dprime_sub_sesssion_plot)
```